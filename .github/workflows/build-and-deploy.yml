name: Build and Deploy Angular App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
    # Step 1: Get code from repository
    - name: Checkout code
      uses: actions/checkout@v4
    
    # Step 2: Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm install
        echo "âœ… Dependencies installed"
    
    # Step 4: Build the app
    - name: Build Angular app
      run: |
        echo "ðŸ”¨ Building Angular app..."
        npm run build -- --configuration production
        echo "âœ… Build completed"
    
    # Step 5: Verify build output
    - name: Verify build
      run: |
        echo "ðŸ” Checking build output..."

        # Check if dist folder exists
        if [ ! -d "dist" ]; then
          echo "âŒ Error: dist folder not found"
          exit 1
        fi
        
        # Check if your app folder exists
        if [ ! -d "dist/car360-gallery-tool-angular" ]; then
          echo "âŒ Error: dist/car360-gallery-tool-angular not found"
          echo "Found these folders in dist:"
          ls -la dist/
          exit 1
        fi
        
        # List files in build
        echo "ðŸ“ Build contents:"
        ls -la dist/car360-gallery-tool-angular/
        
        # Check for index.html
        if [ ! -f "dist/car360-gallery-tool-angular/index.html" ]; then
          echo "âŒ Error: index.html not found"
          exit 1
        fi
        
        BUILD_SIZE=$(du -sh dist/car360-gallery-tool-angular | cut -f1)
        echo "ðŸ“Š Build size: $BUILD_SIZE"
        echo "âœ… Build verification passed!"
    
    # Step 6: Generate timestamp for release
    - name: Generate release timestamp
      id: timestamp
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        echo "ðŸ“… Release timestamp: $TIMESTAMP"
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        # Also save commit info
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
    
    # Step 7: Create release directory
    - name: Create release directory
      run: |
        echo "ðŸ“ Creating release directory..."
        
        RELEASE_DIR="/var/www2/m.aaaauto/htdocs/photo360-beta/releases/${{ steps.timestamp.outputs.timestamp }}"
        
        # Create releases directory if it doesn't exist
        mkdir -p "$RELEASE_DIR"
        
        echo "âœ… Release directory created: $RELEASE_DIR"
    
    # Step 8: Copy built app to release directory
    - name: Deploy to production storage
      run: |
        echo "ðŸ“¤ Copying files to production storage..."
        
        RELEASE_DIR="/var/www2/m.aaaauto/htdocs/photo360-beta/releases/${{ steps.timestamp.outputs.timestamp }}"
        
        # Copy all built files
        cp -r dist/car360-gallery-tool-angular/* "$RELEASE_DIR/"
        
        # Create deployment info file
        cat > "$RELEASE_DIR/deployment.json" << EOF
        {
          "timestamp": "${{ steps.timestamp.outputs.timestamp }}",
          "commit": "${{ steps.timestamp.outputs.commit_sha }}",
          "branch": "${{ steps.timestamp.outputs.branch }}",
          "deployer": "${{ github.actor }}",
          "deploy_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF
        
        echo "âœ… Files copied successfully"
    
    # Step 9: Set proper permissions
    - name: Set permissions
      run: |
        echo "ðŸ”’ Setting proper permissions..."
        
        RELEASE_DIR="/var/www2/m.aaaauto/htdocs/photo360-beta/releases/${{ steps.timestamp.outputs.timestamp }}"
        
        # Set permissions for web server
        find "$RELEASE_DIR" -type f -exec chmod 644 {} \;
        find "$RELEASE_DIR" -type d -exec chmod 755 {} \;
        
        echo "âœ… Permissions set"
    
    # Step 10: Verify deployment
    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."
        
        RELEASE_DIR="/var/www2/m.aaaauto/htdocs/photo360-beta/releases/${{ steps.timestamp.outputs.timestamp }}"
        
        # Check if critical files exist
        if [ ! -f "$RELEASE_DIR/index.html" ]; then
          echo "âŒ Error: index.html not found in release directory"
          exit 1
        fi
        
        # Count files
        FILE_COUNT=$(find "$RELEASE_DIR" -type f | wc -l)
        echo "ðŸ“Š Files deployed: $FILE_COUNT"
        
        # Check directory size
        DIR_SIZE=$(du -sh "$RELEASE_DIR" | cut -f1)
        echo "ðŸ“Š Release size: $DIR_SIZE"
        
        echo "âœ… Deployment verified"
    
    # Step 11: Save current version for rollback
    - name: Save current version
      run: |
        echo "ðŸ’¾ Saving current version for potential rollback..."
        
        BASE_DIR="/var/www/m.aaaauto/htdocs/photo360-beta"

        /var/www/m.aaaauto/htdocs/photo360-beta/Car360GalleryTool/new-360-beta
        
        # If current symlink exists, save it as 'previous'
        if [ -L "$BASE_DIR/current" ]; then
          CURRENT_RELEASE=$(readlink "$BASE_DIR/Car360GalleryTool/new-360-beta")
          ln -sfn "$CURRENT_RELEASE" "$BASE_DIR/releases/previous"
          echo "âœ… Previous version saved: $(basename $CURRENT_RELEASE)"
        else
          echo "âš ï¸ No current version found (first deployment?)"
        fi
    
    # Step 12: Switch to new release (MAKE IT LIVE!)
    - name: Activate new release
      run: |
        echo "ðŸ”„ Switching to new release..."
        
        BASE_DIR="/var/www2/m.aaaauto/htdocs/photo360-beta"
        NEW_RELEASE="$BASE_DIR/releases/${{ steps.timestamp.outputs.timestamp }}"
        
        # Update symlink atomically
        ln -sfn "$NEW_RELEASE" "$BASE_DIR/Car360GalleryTool/new-360-beta"
        
        # Verify symlink
        if [ "$(readlink $BASE_DIR/current)" = "$NEW_RELEASE" ]; then
          echo "âœ… Successfully switched to new release!"
          echo "ðŸŽ‰ DEPLOYMENT IS NOW LIVE!"
        else
          echo "âŒ Failed to update symlink"
          exit 1
        fi
        
        # Show current status
        echo ""
        echo "Current release: ${{ steps.timestamp.outputs.timestamp }}"
        if [ -L "$BASE_DIR/releases/previous" ]; then
          echo "Previous release: $(basename $(readlink $BASE_DIR/releases/previous))"
        fi
    
    # Step 13: Cleanup old releases (keep last 5)
    - name: Cleanup old releases
      run: |
        echo "ðŸ§¹ Cleaning up old releases..."
        
        cd /var/www2/m.aaaauto/htdocs/photo360-beta/releases/
        
        # Count releases
        RELEASE_COUNT=$(ls -1 | wc -l)
        echo "Total releases: $RELEASE_COUNT"
        
        if [ $RELEASE_COUNT -gt 5 ]; then
          # Remove old releases (keep last 5)
          ls -t | tail -n +6 | xargs -r rm -rf
          echo "âœ… Old releases removed"
        else
          echo "âœ… No cleanup needed (keeping all $RELEASE_COUNT releases)"
        fi
    
    # Step 14: Final summary
    - name: Deployment summary
      run: |
        echo "========================================="
        echo "ðŸŽ‰ DEPLOYMENT COMPLETE AND LIVE!"
        echo "========================================="
        echo "ðŸ“¦ Release: ${{ steps.timestamp.outputs.timestamp }}"
        echo "ðŸ”— Commit: ${{ steps.timestamp.outputs.commit_sha }}"
        echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
        echo "ðŸŒ¿ Branch: ${{ steps.timestamp.outputs.branch }}"
        echo "â° Time: $(date)"
        echo ""
        echo "ðŸ“ Live at: /var/www2/m.aaaauto/htdocs/photo360-beta/Car360GalleryTool/new-360-beta"
        echo "========================================="
        
        # Log to deployment history
        echo "[$(date)] ${{ steps.timestamp.outputs.timestamp }} - ${{ github.actor }} - ${{ steps.timestamp.outputs.commit_sha }}" >> /var/www2/m.aaaauto/htdocs/photo360-beta/deployment.log
